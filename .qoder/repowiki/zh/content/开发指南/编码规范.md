# 编码规范

<cite>
**本文档引用的文件**  
- [.clang-format](file://.clang-format)
- [.editorconfig](file://.editorconfig)
- [commitlint.config.js](file://commitlint.config.js)
- [.gitmessage.txt](file://.gitmessage.txt)
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [docs/dev/coding-standards.md](file://docs/dev/coding-standards.md)
- [include/fqtools/processing/processing_pipeline.h](file://include/fqtools/processing/processing_pipeline.h)
- [src/processing/processing_pipeline.cpp](file://src/processing/processing_pipeline.cpp)
- [include/fqtools/io/fastq_reader.h](file://include/fqtools/io/fastq_reader.h)
- [src/io/fastq_reader.cpp](file://src/io/fastq_reader.cpp)
- [scripts/build.sh](file://scripts/build.sh)
- [scripts/lint.sh](file://scripts/lint.sh)
- [scripts/test.sh](file://scripts/test.sh)
- [CMakeLists.txt](file://CMakeLists.txt)
</cite>

## 目录
1. [简介](#简介)
2. [命名约定](#命名约定)
3. [代码格式化规则](#代码格式化规则)
4. [提交信息规范](#提交信息规范)
5. [C++ 最佳实践](#c-最佳实践)
6. [工具脚本规范](#工具脚本规范)
7. [违反规范的示例与修正](#违反规范的示例与修正)

## 简介
本编码规范文档全面阐述了 `fastq-tools` 项目所采用的代码风格与质量控制标准。文档详细说明了命名约定、代码格式化、提交信息格式、C++ 最佳实践以及工具脚本的编写规范。本项目借鉴并适配了 MongoDB 仓库的编码风格，并结合现代 C++20 特性进行了优化，旨在建立一套工程化且易于维护的开发规范。

**Section sources**
- [docs/dev/coding-standards.md](file://docs/dev/coding-standards.md#L1-L170)

## 命名约定
项目在不同上下文中严格遵循特定的命名约定，以确保代码库的一致性和可读性。

| 元素 | 风格 | 示例 |
|------|------|------|
| 代码文件/目录 | `snake_case` | `file_parser.h`, `src/utils/` |
| 文档 | `kebab-case` | `docs/dev/git-guidelines.md` |
| 脚本 | `snake_case` | `scripts/install_deps.sh` |
| 类/结构体 | `PascalCase` | `class FastQReader;` |
| 函数/方法 | `camelCase` | `void processBatch();` |
| 变量（局部变量/参数） | `camelCase` | `int readCount = 0;` |
| 类成员变量 | `camelCase` 并以尾部下划线结尾 | `filePath_` |
| 常量 | `kConstantName` | `constexpr int kMaxReads = 1000;` |
| 命名空间 | `snake_case` | `namespace fq::utils` |

在 C++ 源代码中，这些约定得到了严格遵守。例如，在 `processing_pipeline.cpp` 文件中，类 `SequentialProcessingPipeline` 采用 `PascalCase`，其成员函数 `setInputPath` 和成员变量 `inputPath_` 采用 `camelCase`，并以 `_` 结尾。

**Section sources**
- [docs/dev/coding-standards.md](file://docs/dev/coding-standards.md#L19-L32)
- [src/processing/processing_pipeline.cpp](file://src/processing/processing_pipeline.cpp#L21-L28)

## 代码格式化规则
代码格式化由 `.clang-format` 和 `.editorconfig` 两个文件共同控制，确保了跨编辑器和跨平台的一致性。

`.clang-format` 文件基于 LLVM 风格，定义了详细的格式化规则，包括：
- **缩进**: 4 个空格，禁止使用制表符 (`UseTab: Never`)。
- **列宽**: 100 列 (`ColumnLimit: 100`)。
- **大括号**: 采用 `Attach` 风格，即大括号不换行 (`BreakBeforeBraces: Attach`)。
- **头文件包含顺序**: 项目头文件优先，其次是 C++ 标准库，然后是第三方库，最后是其他头文件。包含顺序会自动分组和排序 (`IncludeBlocks: Regroup`, `SortIncludes: true`)。

`.editorconfig` 文件则提供了更通用的编辑器配置，适用于所有文件类型：
- **换行符**: 统一使用 LF (`end_of_line = lf`)。
- **文件末尾**: 确保文件末尾有换行符 (`insert_final_newline = true`)。
- **缩进**: 对于 C++ 源文件，使用 4 个空格缩进 (`indent_size = 4`)。

开发者可以通过运行 `./scripts/lint.sh format` 命令来自动格式化代码，或使用 `./scripts/lint.sh format-check` 来检查格式是否符合规范。

**Section sources**
- [.clang-format](file://.clang-format#L2-L162)
- [.editorconfig](file://.editorconfig#L1-L35)
- [scripts/lint.sh](file://scripts/lint.sh#L161-L176)

## 提交信息规范
提交信息必须遵循 [Conventional Commits](https://www.conventionalcommits.org/) 规范，由 `commitlint.config.js` 文件进行校验，并通过 `.gitmessage.txt` 模板提供指导。

提交信息的格式为：`<类型>(<作用范围>): <简短描述>`。

### 类型 (Type)
提交类型必须从以下列表中选择：
- `feat`: 新功能 (feature)
- `fix`: 修补 bug
- `docs`: 文档 (documentation)
- `style`: 格式 (不影响代码运行的变动)
- `refactor`: 重构 (既不是新增功能，也不是修改 bug 的代码变动)
- `perf`: 提高性能的优化
- `test`: 增加测试
- `build`: 影响构建系统或外部依赖的更改 (如: Conan, CMake)
- `ci`: 更改 CI 配置和脚本 (如: GitHub Actions)
- `chore`: 非 src 或测试文件的修改 (如: gitignore)
- `revert`: 回滚到上一个版本

### 作用范围 (Scope)
作用范围是可选的，用于指明本次提交影响的模块或组件，例如 `cli`, `io`, `stats`, `core`。

### 正确示例
根据 `.gitmessage.txt` 模板，一个正确的提交信息如下：
```
feat(io): add support for compressed FASTQ input

- Implement reading from .fastq.gz files using zlib
- Update FastqReaderOptions to include compression settings
- Add unit tests for compressed input

Closes #123
```

开发者可以通过在本地设置 `git config --local commit.template .gitmessage.txt` 来使用模板，并通过启用 Git Hook 来强制执行校验。

**Section sources**
- [commitlint.config.js](file://commitlint.config.js#L1-L2)
- [.gitmessage.txt](file://.gitmessage.txt#L1-L31)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L21-L26)

## C++ 最佳实践
项目遵循现代 C++ 开发的最佳实践，强调代码的安全性、可维护性和性能。

### 头文件包含顺序
头文件的包含顺序遵循以下优先级，由 `.clang-format` 的 `IncludeCategories` 规则自动排序：
1.  **本项目公共头文件**: 例如 `#include "fqtools/io/fastq_reader.h"`。
2.  **C++ 标准库**: 例如 `#include <vector>`, `#include <string>`。
3.  **第三方库**: 例如 `#include <spdlog/spdlog.h>`, `#include <tbb/parallel_pipeline.h>`。
4.  **其他头文件**: 其他所有头文件。

这种顺序可以确保头文件的独立性，避免因包含顺序导致的编译错误。

### 命名空间使用
项目使用嵌套的命名空间 `fq::` 来组织代码，防止命名冲突。例如，I/O 相关的类位于 `fq::io` 命名空间下。

### 异常安全性和 RAII 原则
项目优先使用异常进行错误处理，并严格遵守 RAII (Resource Acquisition Is Initialization) 原则。
- **资源管理**: 优先使用智能指针 (`std::unique_ptr`, `std::shared_ptr`) 和容器来管理资源，禁止使用裸露的 `new` 和 `delete`。
- **错误处理**: 在检测到错误时，抛出异常（如 `std::runtime_error`），并在上层进行捕获和处理。
- **RAII**: 在 `fastq_reader.cpp` 中，`FastqReader::Impl` 的析构函数会自动关闭 `gzFile` 句柄，确保了资源的正确释放，即使在发生异常时也不会泄漏。

### 其他现代 C++ 特性
- **尾随返回类型**: 统一使用 `auto func() -> ReturnType` 的语法。
- **`string_view`**: 优先使用 `std::string_view` 作为只读字符串参数，避免不必要的拷贝。
- **`#pragma once`**: 使用 `#pragma once` 作为头文件保护，而不是传统的 `#ifndef` 宏。

**Section sources**
- [docs/dev/coding-standards.md](file://docs/dev/coding-standards.md#L74-L108)
- [src/io/fastq_reader.cpp](file://src/io/fastq_reader.cpp#L29-L32)
- [src/processing/processing_pipeline.cpp](file://src/processing/processing_pipeline.cpp#L37-L38)

## 工具脚本规范
项目中的 Bash 脚本（位于 `scripts/` 目录下）遵循统一的规范，确保其健壮性和可维护性。

### 脚本结构
- **Shebang**: 所有脚本以 `#!/bin/bash` 开头。
- **严格模式**: 使用 `set -euo pipefail` 启用严格模式，确保脚本在出错时立即退出。
- **函数命名**: 函数名使用 `snake_case`，例如 `print_info()`。
- **变量引用**: 变量引用时使用双引号包裹，例如 `run_build "$compiler" "$build_type"`，以防止路径中包含空格时出现问题。

### 统一工具
项目提供了三个核心脚本：
- `build.sh`: 统一的构建脚本，支持多种编译器（gcc/clang）和构建类型（Debug/Release/Sanitize）。
- `lint.sh`: 代码质量检查脚本，集成了 `clang-tidy` 和 `clang-format`。
- `test.sh`: 测试运行脚本，支持过滤、重复运行和生成覆盖率报告。

这些脚本的设计保证了开发流程的自动化和一致性。

**Section sources**
- [scripts/build.sh](file://scripts/build.sh#L1-L319)
- [scripts/lint.sh](file://scripts/lint.sh#L1-L198)
- [scripts/test.sh](file://scripts/test.sh#L1-L271)

## 违反规范的示例与修正
本节提供了一些常见的违反规范的示例及其修正方法。

### 示例 1：错误的命名
**错误**:
```cpp
// 错误：类名应为 PascalCase
class fastq_reader {
    // 错误：成员变量应为 camelCase 并以 _ 结尾
    std::string InputPath;
};
```

**修正**:
```cpp
// 正确：类名使用 PascalCase
class FastqReader {
public:
    // 正确：成员变量使用 camelCase 并以 _ 结尾
    void setInputPath(const std::string& inputPath) { inputPath_ = inputPath; }
private:
    std::string inputPath_;
};
```

### 示例 2：错误的头文件包含顺序
**错误**:
```cpp
#include <vector>
#include "fqtools/io/fastq_reader.h" // 项目头文件应在最前
#include <spdlog/spdlog.h>
```

**修正**:
```cpp
#include "fqtools/io/fastq_reader.h"
#include <vector>
#include <spdlog/spdlog.h>
```

### 示例 3：错误的提交信息
**错误**:
```
fixed a bug in the reader
```

**修正**:
```
fix(io): fix memory leak in FastqReader

- Ensure gzFile is closed in the destructor
- Add null check before closing

Closes #456
```

通过遵循本规范，开发者可以快速适应项目风格，确保代码库的整体质量和一致性。

**Section sources**
- [include/fqtools/io/fastq_reader.h](file://include/fqtools/io/fastq_reader.h#L17-L43)
- [src/processing/processing_pipeline.cpp](file://src/processing/processing_pipeline.cpp#L21-L28)
- [.gitmessage.txt](file://.gitmessage.txt#L1-L31)