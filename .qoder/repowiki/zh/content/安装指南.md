# 安装指南

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [docs/installation.md](file://docs/installation.md)
- [scripts/build.sh](file://scripts/build.sh)
- [scripts/install_deps.sh](file://scripts/install_deps.sh)
- [scripts/install_runtime.sh](file://scripts/install_runtime.sh)
- [scripts/docker_deploy.sh](file://scripts/docker_deploy.sh)
- [scripts/devcontainer_setup.sh](file://scripts/devcontainer_setup.sh)
- [conanfile.py](file://conanfile.py)
- [config/dependencies/conanfile.py](file://config/dependencies/conanfile.py)
- [CMakeLists.txt](file://CMakeLists.txt)
- [docker/Dockerfile](file://docker/Dockerfile)
- [docker/Dockerfile.dev](file://docker/Dockerfile.dev)
- [docker/docker-compose.yml](file://docker/docker-compose.yml)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [从源码构建](#从源码构建)
4. [Docker安装](#docker安装)
5. [开发环境配置](#开发环境配置)
6. [包管理器安装](#包管理器安装)
7. [故障排除](#故障排除)

## 简介
FastQTools 是一个面向 FASTQ 文件的现代 C++ 高性能处理工具集，专注于生物信息学场景中的质控、过滤和统计分析。本指南详细介绍了所有支持的安装方法，包括从源码构建、Docker 安装以及开发环境配置，帮助用户根据具体需求选择最适合的安装方式。

## 系统要求
### 最低运行时要求
- **操作系统**: Ubuntu 20.04+ 或 Debian 11+
- **内存**: 1GB RAM
- **磁盘空间**: 100MB
- **依赖库**: ca-certificates, libtbb12, zlib1g, libbz2-1.0, liblzma5, libdeflate0

### 推荐开发要求
- **操作系统**: Ubuntu 22.04+ 或 Debian 12+
- **内存**: 4GB RAM
- **磁盘空间**: 2GB
- **CPU**: 多核 CPU 以支持并行构建
- **编译器**: 支持 C++20 的 GCC 11+ 或 Clang 19
- **构建工具**: CMake ≥ 3.20, Ninja, Conan

**Section sources**
- [README.md](file://README.md#L88-L95)
- [docs/installation.md](file://docs/installation.md#L124-L135)

## 从源码构建
从源码构建是开发和自定义 FastQTools 的推荐方式。该过程包括克隆仓库、安装依赖、配置构建环境和编译。

### 1. 克隆仓库
```bash
git clone https://github.com/LessUp/FastQTools.git
cd FastQTools
```

### 2. 安装依赖
使用 `install_deps.sh` 脚本安装开发依赖：
```bash
./scripts/install_deps.sh --dev
```
此脚本会自动安装编译器、CMake、Conan、Clang 工具链以及所有必要的开发库。

### 3. 使用Conan管理依赖
项目使用 `conanfile.py` 来管理第三方依赖。`config/dependencies/conanfile.py` 文件定义了所有依赖项，包括：
- cxxopts (3.1.1)
- spdlog (1.12.0)
- fmt (10.2.1)
- zlib (1.3)
- bzip2 (1.0.8)
- xz_utils (5.4.5)
- nlohmann_json (3.11.3)
- onetbb (2021.10.0)

在构建前，Conan 会自动下载并配置这些依赖。

### 4. 通过CMake配置构建环境
项目使用现代 CMake 构建系统。`CMakeLists.txt` 文件定义了项目结构、编译标准（C++20）和编译器检查。构建系统会强制要求 GCC 11+ 或 Clang 12+ 以确保 C++20 支持。

### 5. 调用build.sh脚本进行编译
使用 `build.sh` 脚本进行一键构建：
```bash
# 使用 Clang 在 Release 模式下构建（默认）
./scripts/build.sh

# 使用 GCC 在 Debug 模式下构建
./scripts/build.sh gcc Debug

# 启用 AddressSanitizer 进行调试
./scripts/build.sh clang Debug --asan
```
该脚本会自动处理 Conan 安装、CMake 配置和 Ninja 构建，并支持多种构建选项，如代码覆盖率和静态分析。

**Section sources**
- [scripts/build.sh](file://scripts/build.sh)
- [scripts/install_deps.sh](file://scripts/install_deps.sh)
- [conanfile.py](file://conanfile.py)
- [config/dependencies/conanfile.py](file://config/dependencies/conanfile.py)
- [CMakeLists.txt](file://CMakeLists.txt)

## Docker安装
Docker 提供了生产部署和跨平台运行的便捷方式，确保环境一致性。

### 1. 使用Dockerfile构建生产镜像
`docker/Dockerfile` 采用多阶段构建：
- **构建阶段**: 基于 `gcc:14.2-bookworm`，安装完整的构建工具链，编译项目
- **生产阶段**: 基于 `debian:12-slim`，仅包含运行时依赖和编译好的二进制文件，确保镜像小巧安全

构建生产镜像：
```bash
docker build -f docker/Dockerfile -t fastqtools:latest --target production .
```

### 2. 使用docker-compose.yml进行服务编排
`docker/docker-compose.yml` 定义了多个服务：
- **dev**: 开发环境，挂载源码目录，支持热重载
- **prod**: 生产环境，运行优化后的二进制文件
- **test**: 测试环境，用于 CI/CD 流水线
- **build**: 构建服务，用于在容器内编译项目

使用示例：
```bash
# 启动开发环境
docker-compose -f docker/docker-compose.yml up -d dev

# 启动生产环境
docker-compose -f docker/docker-compose.yml up -d prod

# 运行测试
docker-compose -f docker/docker-compose.yml up test
```

### 3. 使用docker_deploy.sh脚本
`scripts/docker_deploy.sh` 是一个综合的 Docker 部署脚本，支持多种环境和操作：
```bash
# 构建生产镜像
./scripts/docker_deploy.sh --env production --action build

# 运行开发环境
./scripts/docker_deploy.sh --env development --action run

# 推送镜像到注册表
./scripts/docker_deploy.sh --action push --registry myregistry.com/fastqtools --tag v3.1.0
```

**Section sources**
- [docker/Dockerfile](file://docker/Dockerfile)
- [docker/docker-compose.yml](file://docker/docker-compose.yml)
- [scripts/docker_deploy.sh](file://scripts/docker_deploy.sh)

## 开发环境配置
### DevContainer配置
项目支持 VS Code DevContainer，提供开箱即用的开发环境。

#### 配置文件
- `.devcontainer/devcontainer.json`: 使用 docker-compose 的完整配置
- `.devcontainer/devcontainer.simple.json`: 单一 Dockerfile 的简单配置

#### devcontainer_setup.sh脚本
`scripts/devcontainer_setup.sh` 在容器启动时自动运行，执行以下操作：
- 配置 Conan 个人资料
- 设置编译器缓存 (ccache)
- 创建必要目录 (build, .vscode)
- 配置 Git 用户信息
- 验证构建系统 (cmake, ninja, conan)

启动后，开发环境已预装 Clang/LLVM 19 工具链、CMake、Ninja 和 Conan，可直接进行开发和测试。

**Section sources**
- [docker/Dockerfile.dev](file://docker/Dockerfile.dev)
- [scripts/devcontainer_setup.sh](file://scripts/devcontainer_setup.sh)

## 包管理器安装
目前 FastQTools 尚未发布到主流包管理器（如 apt、brew）。用户可通过以下方式获取：
- **从源码构建**: 适用于需要最新功能或进行开发的用户
- **Docker 镜像**: 适用于生产部署和快速试用
- **等待正式发布**: 项目未来计划支持 Conan 和 vcpkg 等 C++ 包管理器

**Section sources**
- [README.md](file://README.md#L124-L126)

## 故障排除
### 常见问题
1. **缺少 libdeflate**: 确保使用 Ubuntu 22.04+ 或从源码安装
2. **Clang 未找到**: 运行 `sudo update-alternatives --config clang` 设置默认版本
3. **Conan 配置文件**: 运行 `conan profile detect --force` 重新生成
4. **Docker 权限错误**: 确保用户在 `docker` 用户组中

### 验证安装
```bash
# 检查运行时库
ldconfig -p | grep -E "(tbb|deflate|lzma|bz2)"

# 检查开发工具
clang --version
cmake --version
conan --version

# 测试 FastQTools
./build/FastQTools --help
```

**Section sources**
- [docs/installation.md](file://docs/installation.md#L137-L160)
- [scripts/install_runtime.sh](file://scripts/install_runtime.sh)