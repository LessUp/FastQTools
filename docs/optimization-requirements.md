# FastQTools Optimization Requirements

本文档概述了 FastQTools 项目的优化需求，旨在提升处理性能、鲁棒性和可扩展性。

## 1. 性能优化需求

### 1.1 IO 层优化
- **Remainder 处理优化**: 在 `FastqReader` 中消除处理缓冲区残留数据时的物理拷贝。
- **libdeflate 集成**: 替换传统的 `zlib` 为 `libdeflate`，利用其更高效的压缩/解压算法。
- **Huge Pages 支持**: 支持大内存页分配，减少 TLB miss，提升大缓冲区场景下的访问速度。

### 1.2 计算加速
- **SIMD 指令集应用**:
  - 在 `QualityTrimmer` 中使用 SSE4.2/AVX2 批量处理质量得分判断。
  - 在 `FqStatistic` 中使用 SIMD 进行碱基计数和质量分布统计。
  - 在 `AdapterTrimmer` 中加速错配 (mismatch) 计算。
- **并行解析**: 实现多线程并行解析缓冲区内容，进一步分担 IO 后的 CPU 压力。
- **内存预取 (Prefetching)**: 在解析和处理循环中手动插入预取指令，降低缓存缺失率。

## 2. 功能与鲁棒性需求

### 2.1 增强解析器验证
- **合法性校验**: 增加对 FASTQ 格式的严格校验（Header `@`, Separator `+`, 序列质量长度一致性）。
- **详细错误上报**: 在解析失败时输出具体的行号、文件偏移量和错误原因，而非简单的跳过或崩溃。

### 2.2 异步日志系统
- **异步写入**: 确保 `spdlog` 的日志记录不阻塞主处理流水线，尤其是在 Debug 模式下。

## 3. 架构可扩展性需求

### 3.1 动态插件系统
- **动态加载**: 支持通过 `dlopen` 机制动态加载外部定义的 `ReadMutator` 和 `ReadPredicate` 插件。
- **命令行集成**: 在 CLI 中增加参数，允许用户指定外部插件 `.so` 文件的路径。
- **ABI 稳定**: 定义一套稳定的接口规范，方便第三方开发者扩展功能。

## 4. 其它优化
- **缓冲区循环利用**: 引入对象池或内存池，减少 `FastqBatch` 等大对象的频繁创建与销毁开销。
- **NUMA 感知**: 在多路系统中优化线程调度与内存分配（可选，针对极致性能）。
