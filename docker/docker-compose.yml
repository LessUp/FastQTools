services:
  # 开发环境
  dev:
    image: fastqtools-dev
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
      target: development
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
    container_name: fastqtools-dev
    volumes:
      - ..:/workspace:cached
      - conan_cache:/home/developer/.conan2:cached
      - ccache_cache:/home/developer/.ccache:cached
    ports:
      - "${FASTQTOOLS_SSH_BIND:-127.0.0.1}:${FASTQTOOLS_SSH_PORT:-2222}:2222"
    stdin_open: true
    tty: true
    command: /bin/bash
    working_dir: /workspace

  # 生产环境
  prod:
    image: fastqtools-prod
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: production
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
    container_name: fastqtools-prod
    volumes:
      - ./data:/app/data:ro
      - ./output:/app/output
    environment:
      - FASTQTOOLS_DATA_DIR=/app/data
      - FASTQTOOLS_OUTPUT_DIR=/app/output
    ports:
      - "8080:8080"
    restart: unless-stopped

  # 测试环境
  test:
    image: fastqtools-test
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
      target: development
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
    container_name: fastqtools-test
    volumes:
      - ..:/workspace:cached
      - conan_cache:/home/developer/.conan2:cached
      - ccache_cache:/home/developer/.ccache:cached
    environment:
      - BUILD_TYPE=Debug
      - ENABLE_COVERAGE=ON
    command: /workspace/scripts/test.sh
    working_dir: /workspace

  # 构建服务
  build:
    image: fastqtools-build
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: build
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-0}
    container_name: fastqtools-build
    volumes:
      - ..:/workspace:cached
      - conan_cache:/root/.conan2:cached
      - ccache_cache:/root/.ccache:cached
    command: /workspace/scripts/build.sh --release
    working_dir: /workspace

volumes:
  conan_cache:
  ccache_cache:
