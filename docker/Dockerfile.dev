# Dockerfile for the Development Environment
#
# This Dockerfile creates a comprehensive development environment.
# It inherits from the 'build' stage of the main Dockerfile
# to ensure a consistent base toolchain, and then adds extra tools
# needed for interactive development.

# 开发环境基础镜像（自包含，不依赖其他 Dockerfile 的 stage）
FROM gcc:14.2-bookworm AS base

# 基础工具链
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    ninja-build \
    pkg-config \
    git \
    wget \
    gnupg \
    lsb-release \
    software-properties-common \
    python3 \
    python3-pip \
    ccache \
    && rm -rf /var/lib/apt/lists/*

RUN wget -q https://apt.llvm.org/llvm.sh && \
    chmod +x llvm.sh && \
    ./llvm.sh 19 && \
    apt-get update && \
    apt-get install -y \
    clang-19 \
    clangd-19 \
    clang-tidy-19 \
    clang-format-19 \
    lld-19 \
    llvm-19 && \
    rm -f llvm.sh && \
    rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100 && \
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100 && \
    update-alternatives --install /usr/bin/clangd clangd /usr/bin/clangd-19 100 && \
    update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-19 100 && \
    update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-19 100

# Conan (使用 --break-system-packages 绕过 PEP 668 限制)
RUN pip3 install --no-cache-dir --break-system-packages conan==2.19.0

# 环境变量
ENV CC=clang
ENV CXX=clang++
ENV CONAN_HOME=/home/developer/.conan2
ENV CCACHE_DIR=/home/developer/.ccache
ENV PATH=/usr/lib/ccache:$PATH

# 额外的开发工具
FROM base AS development
RUN apt-get update && apt-get install -y --no-install-recommends \
    gdb \
    valgrind \
    lcov \
    doxygen \
    graphviz \
    && rm -rf /var/lib/apt/lists/*

# 非 root 用户
ARG USERNAME=developer
ARG USER_UID=1000
ARG USER_GID=$USER_UID
RUN groupadd --gid $USER_GID $USERNAME && \
    useradd --uid $USER_UID --gid $USER_GID -m $USERNAME && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# 工作目录与权限
RUN mkdir -p /workspace && chown $USERNAME:$USERNAME /workspace

USER $USERNAME
WORKDIR /workspace

# 默认启动 bash
CMD ["/bin/bash"]
