# Dockerfile for the Development Environment
#
# This Dockerfile creates a comprehensive development environment.
# It inherits from the 'build' stage of the main Dockerfile
# to ensure a consistent base toolchain, and then adds extra tools
# needed for interactive development.

# 开发环境基础镜像（自包含，不依赖其他 Dockerfile 的 stage）
FROM gcc:15.2-bookworm AS base

ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG ALL_PROXY
ARG NO_PROXY

ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
ENV ALL_PROXY=${ALL_PROXY}
ENV NO_PROXY=${NO_PROXY}
ENV http_proxy=${HTTP_PROXY}
ENV https_proxy=${HTTPS_PROXY}
ENV all_proxy=${ALL_PROXY}
ENV no_proxy=${NO_PROXY}

RUN set -eux; \
    if [ -n "${HTTP_PROXY:-}" ] || [ -n "${HTTPS_PROXY:-}" ]; then \
        : > /etc/apt/apt.conf.d/99proxy; \
        if [ -n "${HTTP_PROXY:-}" ]; then echo "Acquire::http::Proxy \"${HTTP_PROXY}\";" >> /etc/apt/apt.conf.d/99proxy; fi; \
        if [ -n "${HTTPS_PROXY:-}" ]; then echo "Acquire::https::Proxy \"${HTTPS_PROXY}\";" >> /etc/apt/apt.conf.d/99proxy; fi; \
    fi

# 基础工具链
RUN apt-get update && apt-get install -y \
    build-essential \
    ninja-build \
    pkg-config \
    git \
    wget \
    tar \
    xz-utils \
    gnupg \
    lsb-release \
    software-properties-common \
    python3 \
    python3-pip \
    ccache \
    && rm -rf /var/lib/apt/lists/*

RUN CMAKE_VERSION=4.2.1 && \
    ARCH="$(dpkg --print-architecture)" && \
    case "$ARCH" in \
        amd64) CMAKE_ARCH="x86_64" ;; \
        arm64) CMAKE_ARCH="aarch64" ;; \
        *) echo "Unsupported architecture: $ARCH"; exit 1 ;; \
    esac && \
    wget -q "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-${CMAKE_ARCH}.tar.gz" -O /tmp/cmake.tar.gz && \
    mkdir -p /opt && \
    tar -C /opt -xzf /tmp/cmake.tar.gz && \
    ln -sf "/opt/cmake-${CMAKE_VERSION}-linux-${CMAKE_ARCH}/bin/cmake" /usr/local/bin/cmake && \
    ln -sf "/opt/cmake-${CMAKE_VERSION}-linux-${CMAKE_ARCH}/bin/ctest" /usr/local/bin/ctest && \
    ln -sf "/opt/cmake-${CMAKE_VERSION}-linux-${CMAKE_ARCH}/bin/cpack" /usr/local/bin/cpack && \
    rm -f /tmp/cmake.tar.gz

RUN wget -q https://apt.llvm.org/llvm.sh && \
    chmod +x llvm.sh && \
    ./llvm.sh 21 && \
    apt-get update && \
    apt-get install -y \
    clang-21 \
    clangd-21 \
    clang-tidy-21 \
    clang-format-21 \
    lld-21 \
    llvm-21 && \
    rm -f llvm.sh && \
    rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 100 && \
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-21 100 && \
    update-alternatives --install /usr/bin/clangd clangd /usr/bin/clangd-21 100 && \
    update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-21 100 && \
    update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-21 100

# Conan (使用 --break-system-packages 绕过 PEP 668 限制)
RUN pip3 install --no-cache-dir --break-system-packages conan==2.24.0

# 环境变量
ENV CC=clang
ENV CXX=clang++
ENV CONAN_HOME=/home/developer/.conan2
ENV CCACHE_DIR=/home/developer/.ccache
ENV PATH=/usr/lib/ccache:$PATH

# 额外的开发工具
FROM base AS development
RUN apt-get update && apt-get install -y --no-install-recommends \
    gdb \
    valgrind \
    lcov \
    doxygen \
    graphviz \
    && rm -rf /var/lib/apt/lists/*

# 非 root 用户
ARG USERNAME=developer
ARG USER_UID=1000
ARG USER_GID=$USER_UID
RUN groupadd --gid $USER_GID $USERNAME && \
    useradd --uid $USER_UID --gid $USER_GID -m $USERNAME && \
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# 工作目录与权限
RUN mkdir -p /workspace && chown $USERNAME:$USERNAME /workspace

USER $USERNAME
WORKDIR /workspace

# 默认启动 bash
CMD ["/bin/bash"]
