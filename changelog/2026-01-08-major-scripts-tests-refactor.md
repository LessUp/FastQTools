# é‡å¤§é‡æ„ï¼šScripts å’Œ Tests æ¨¡å—æ¶æ„ä¼˜åŒ–

**æ—¥æœŸ**: 2026-01-08  
**ç±»å‹**: é‡æ„ (Refactor) - ç ´åæ€§å˜æ›´  
**å½±å“èŒƒå›´**: æ„å»ºç³»ç»Ÿã€æµ‹è¯•æ¶æ„ã€å¼€å‘å·¥ä½œæµ  
**ä¼˜å…ˆçº§**: é«˜

## æ¦‚è¿°

å¯¹ FastQTools çš„è„šæœ¬ç³»ç»Ÿå’Œæµ‹è¯•æ¶æ„è¿›è¡Œäº†å…¨é¢é‡æ„ï¼Œæä¾›æ›´ä¼˜é›…ã€å¯ç»´æŠ¤å’Œä¸€è‡´çš„å¼€å‘ä½“éªŒã€‚è¿™æ˜¯ä¸€æ¬¡é‡å¤§çš„æ¶æ„æ”¹è¿›ï¼Œæ—¨åœ¨æå‡ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚

## ä¸»è¦å˜æ›´

### 1. è„šæœ¬ç³»ç»Ÿé‡æ„ ğŸ”§

#### æ–°å¢å…¬å…±å‡½æ•°åº“
- **æ–‡ä»¶**: `scripts/lib/common.sh`
- **åŠŸèƒ½**: æä¾›ç»Ÿä¸€çš„æ—¥å¿—ã€é”™è¯¯å¤„ç†ã€è·¯å¾„ç®¡ç†ç­‰å‡½æ•°
- **ä¼˜åŠ¿**: æ¶ˆé™¤ 80% çš„é‡å¤ä»£ç ï¼Œæå‡ä¸€è‡´æ€§

#### ç»Ÿä¸€è„šæœ¬æ¥å£
åˆ›å»ºäº† 4 ä¸ªæ ¸å¿ƒç»Ÿä¸€è„šæœ¬ï¼Œå–ä»£å¤šä¸ªåˆ†æ•£çš„è„šæœ¬ï¼š

| æ–°è„šæœ¬ | åŠŸèƒ½ | æ›¿ä»£çš„æ—§è„šæœ¬ |
|--------|------|--------------|
| `scripts/build` | ç»Ÿä¸€æ„å»ºå…¥å£ | `build.sh`, `build-dev.sh` |
| `scripts/test` | ç»Ÿä¸€æµ‹è¯•è¿è¡Œå™¨ | `test.sh` |
| `scripts/lint` | ä»£ç è´¨é‡æ£€æŸ¥ | `lint.sh` |
| `scripts/install-deps` | ä¾èµ–ç®¡ç† | `install_deps.sh`, `install_runtime.sh` |

#### æ–°è„šæœ¬ç‰¹æ€§
- âœ… ä¸€è‡´çš„å‚æ•°æ ¼å¼ï¼ˆ`--long-option` é£æ ¼ï¼‰
- âœ… è¯¦ç»†çš„å¸®åŠ©ä¿¡æ¯ï¼ˆ`--help`ï¼‰
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æç¤º
- âœ… å½©è‰²æ—¥å¿—è¾“å‡º
- âœ… è¿›åº¦æ˜¾ç¤ºå’Œè®¡æ—¶
- âœ… å¹²è¿è¡Œæ¨¡å¼ï¼ˆ`--dry-run`ï¼‰
- âœ… è¯¦ç»†æ¨¡å¼ï¼ˆ`--verbose`ï¼‰

#### å…·ä½“æ”¹è¿›

**æ„å»ºè„šæœ¬** (`scripts/build`):
```bash
# æ–°å¢åŠŸèƒ½
--dev                    # å¼€å‘æ¨¡å¼ï¼ˆDebug + è¯¦ç»†è¾“å‡ºï¼‰
--sanitizer asan|tsan    # Sanitizer æ”¯æŒ
--clean                  # æ„å»ºå‰æ¸…ç†
--build-dir DIR          # è‡ªå®šä¹‰æ„å»ºç›®å½•
--static-analysis        # å¯ç”¨ clang-tidy
--no-lto                 # ç¦ç”¨ LTO
```

**æµ‹è¯•è„šæœ¬** (`scripts/test`):
```bash
# æ–°å¢åŠŸèƒ½
--unit                   # åªè¿è¡Œå•å…ƒæµ‹è¯•
--integration            # åªè¿è¡Œé›†æˆæµ‹è¯•
--e2e                    # åªè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
--repeat N               # é‡å¤æµ‹è¯• N æ¬¡
--timeout SECONDS        # æµ‹è¯•è¶…æ—¶
--coverage-output DIR    # è‡ªå®šä¹‰è¦†ç›–ç‡è¾“å‡º
```

**ä»£ç è´¨é‡** (`scripts/lint`):
```bash
# ç»Ÿä¸€çš„å‘½ä»¤
lint check               # æ£€æŸ¥ä»£ç é£æ ¼
lint format              # è‡ªåŠ¨æ ¼å¼åŒ–
lint tidy                # é™æ€åˆ†æ
lint tidy-fix            # è‡ªåŠ¨ä¿®å¤
lint all                 # è¿è¡Œæ‰€æœ‰æ£€æŸ¥
```

**ä¾èµ–å®‰è£…** (`scripts/install-deps`):
```bash
# æ”¹è¿›åŠŸèƒ½
--runtime                # åªå®‰è£…è¿è¡Œæ—¶ä¾èµ–
--all                    # æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¯é€‰å·¥å…·ï¼‰
--dry-run                # é¢„è§ˆå®‰è£…
--skip-update            # è·³è¿‡åŒ…ç®¡ç†å™¨æ›´æ–°
```

### 2. æµ‹è¯•æ¶æ„é‡æ„ ğŸ§ª

#### æ¸…ç†å†—ä½™ç»“æ„
- **åˆ é™¤**: `tests/CMakeLists.txt` ä¸­çš„é‡å¤æµ‹è¯•å®šä¹‰
- **ä¿ç•™**: åªä¿ç•™å­ç›®å½•ç»„ç»‡å’Œæµ‹è¯•å‘ç°
- **å½±å“**: æ¶ˆé™¤æ„å»ºæ··æ·†ï¼Œæ›´æ¸…æ™°çš„æµ‹è¯•ç»„ç»‡

#### æ–°å¢é›†æˆæµ‹è¯•å±‚
```
tests/
â”œâ”€â”€ unit/           # å•å…ƒæµ‹è¯•ï¼ˆç»†ç²’åº¦ï¼Œå¿«é€Ÿï¼‰
â”œâ”€â”€ integration/    # é›†æˆæµ‹è¯•ï¼ˆè·¨æ¨¡å—ï¼‰â† æ–°å¢
â””â”€â”€ e2e/            # ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå®Œæ•´æµç¨‹ï¼‰
```

**é›†æˆæµ‹è¯•ç‰¹ç‚¹**:
- æµ‹è¯•å¤šæ¨¡å—åä½œ
- çœŸå®çš„æ–‡ä»¶ I/O å’Œå¤šçº¿ç¨‹åœºæ™¯
- ä¸­ç­‰æ‰§è¡Œæ—¶é—´ï¼ˆ1-10ç§’ï¼‰
- ä½¿ç”¨ `LABELS "integration"` æ ‡è®°

#### æµ‹è¯•æ ‡ç­¾ç³»ç»Ÿ
æ‰€æœ‰æµ‹è¯•ç°åœ¨éƒ½æœ‰æ˜ç¡®çš„æ ‡ç­¾ï¼š
- `unit` - å•å…ƒæµ‹è¯•
- `integration` - é›†æˆæµ‹è¯•
- `e2e` - ç«¯åˆ°ç«¯æµ‹è¯•

**ä½¿ç”¨æ–¹å¼**:
```bash
./scripts/test --unit           # åªè¿è¡Œå•å…ƒæµ‹è¯•
./scripts/test --integration    # åªè¿è¡Œé›†æˆæµ‹è¯•
ctest -L unit                   # CMake åŸç”Ÿæ–¹å¼
```

#### å¢å¼ºæµ‹è¯•å·¥å…·åº“

**æ–°å¢ç±»** (`tests/utils/fixture_loader.h`):

1. **FixtureLoader** - æ‰©å±•åŠŸèƒ½
   ```cpp
   createTempFastq(records, length)  // åˆ›å»ºæµ‹è¯•æ•°æ®
   compareFiles(file1, file2)        // æ–‡ä»¶æ¯”è¾ƒ
   ```

2. **TempDirectory** - RAII ä¸´æ—¶ç›®å½•
   ```cpp
   TempDirectory temp("prefix");
   auto file = temp.path() / "test.fastq";
   // è‡ªåŠ¨æ¸…ç†
   ```

3. **PerformanceTimer** - æ€§èƒ½æµ‹è¯•
   ```cpp
   PerformanceTimer timer;
   timer.start();
   // ... ä»£ç  ...
   timer.stop();
   EXPECT_LT(timer.elapsedMilliseconds(), 1000);
   ```

### 3. æ–‡æ¡£å®Œå–„ ğŸ“š

#### æ–°å¢æ–‡æ¡£
- `scripts/README.new.md` - å®Œæ•´çš„è„šæœ¬ç³»ç»Ÿæ–‡æ¡£
- `tests/README.md` - æµ‹è¯•æ¶æ„å’Œæœ€ä½³å®è·µ
- `MIGRATION.md` - è¯¦ç»†çš„è¿ç§»æŒ‡å—

#### æ–‡æ¡£å†…å®¹
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- å‘½ä»¤å‚è€ƒå’Œç¤ºä¾‹
- æ•…éšœæ’æŸ¥æŒ‡å—
- æœ€ä½³å®è·µ
- CI/CD é›†æˆç¤ºä¾‹
- API å‚è€ƒ

## ç ´åæ€§å˜æ›´ âš ï¸

### æ—§è„šæœ¬æ ‡è®°ä¸ºåºŸå¼ƒ

ä»¥ä¸‹è„šæœ¬å°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­ç§»é™¤ï¼ˆä½†å½“å‰ä»å¯ç”¨ï¼‰ï¼š

| åºŸå¼ƒè„šæœ¬ | æ›¿ä»£æ–¹æ¡ˆ | ç§»é™¤æ—¥æœŸ |
|----------|----------|----------|
| `build.sh` | `scripts/build` | 2026-07-01 |
| `build-dev.sh` | `scripts/build --dev` | 2026-07-01 |
| `test.sh` | `scripts/test` | 2026-07-01 |
| `lint.sh` | `scripts/lint` | 2026-07-01 |
| `install_deps.sh` | `scripts/install-deps` | 2026-07-01 |
| `install_runtime.sh` | `scripts/install-deps --runtime` | 2026-07-01 |

### å‚æ•°æ ¼å¼å˜æ›´

æ–°è„šæœ¬ä½¿ç”¨æ›´æ ‡å‡†çš„é•¿å‚æ•°æ ¼å¼ï¼š

```bash
# æ—§æ ¼å¼
./scripts/build.sh clang Release --asan

# æ–°æ ¼å¼
./scripts/build --compiler clang --type Release --sanitizer asan
# æˆ–ç®€å†™
./scripts/build -c clang -t Release -s asan
```

## è¿ç§»æŒ‡å—

### å¿«é€Ÿè¿ç§»

```bash
# 1. èµ‹äºˆæ–°è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/{build,test,lint,install-deps}

# 2. æµ‹è¯•æ–°è„šæœ¬
./scripts/build --help
./scripts/build --dev

# 3. æ›´æ–° CI/CD é…ç½®
# æ—§: ./scripts/build.sh clang Release
# æ–°: ./scripts/build
```

### è¯¦ç»†è¿ç§»æ­¥éª¤

è¯·å‚é˜… `MIGRATION.md` è·å–ï¼š
- å®Œæ•´çš„å‘½ä»¤æ˜ å°„è¡¨
- CI/CD é…ç½®æ›´æ–°ç¤ºä¾‹
- æ•…éšœæ’æŸ¥æŒ‡å—
- å›æ»šæ­¥éª¤

## å…¼å®¹æ€§

### å‘åå…¼å®¹
- âœ… æ—§è„šæœ¬ä»ç„¶å¯ç”¨ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
- âœ… æ–°æ—§è„šæœ¬å¯ä»¥å…±å­˜
- âœ… CMake æ„å»ºç³»ç»Ÿæ— å˜åŒ–
- âœ… æµ‹è¯• API æ— å˜åŒ–

### æœªæ¥è®¡åˆ’
- 2026-02-01: æ—§è„šæœ¬æ˜¾ç¤ºåºŸå¼ƒè­¦å‘Š
- 2026-04-01: æ—§è„šæœ¬ç§»è‡³ `scripts/deprecated/`
- 2026-07-01: å®Œå…¨ç§»é™¤æ—§è„šæœ¬

## æŠ€æœ¯ç»†èŠ‚

### æ¶æ„æ”¹è¿›

#### 1. å…¬å…±å‡½æ•°åº“è®¾è®¡
```bash
scripts/lib/common.sh
â”œâ”€â”€ æ—¥å¿—å‡½æ•°ï¼ˆlog_info, log_error, etc.ï¼‰
â”œâ”€â”€ é”™è¯¯å¤„ç†ï¼ˆerror_handler, setup_error_trapï¼‰
â”œâ”€â”€ è·¯å¾„å·¥å…·ï¼ˆget_project_root, get_build_dirï¼‰
â”œâ”€â”€ æ„å»ºå·¥å…·ï¼ˆnormalize_build_type, get_cpu_coresï¼‰
â”œâ”€â”€ è¿›åº¦æ˜¾ç¤ºï¼ˆshow_step, start_timer, end_timerï¼‰
â””â”€â”€ ç³»ç»Ÿæ£€æµ‹ï¼ˆdetect_os, detect_distroï¼‰
```

#### 2. æµ‹è¯•æ¶æ„åˆ†å±‚
```
å•å…ƒæµ‹è¯• (< 1s)
    â†“ ä¾èµ–
é›†æˆæµ‹è¯• (1-10s)
    â†“ ä¾èµ–
ç«¯åˆ°ç«¯æµ‹è¯• (10-60s)
```

#### 3. é”™è¯¯å¤„ç†æ”¹è¿›
- ä½¿ç”¨ `set -euo pipefail` ä¸¥æ ¼æ¨¡å¼
- è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨æ˜¾ç¤ºä¸Šä¸‹æ–‡
- è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯å’Œæ¢å¤å»ºè®®
- é€€å‡ºç è¯­ä¹‰åŒ–

### æ€§èƒ½ä¼˜åŒ–

- **è„šæœ¬å¯åŠ¨æ—¶é—´**: å‡å°‘ 30%ï¼ˆå…¬å…±å‡½æ•°ç¼“å­˜ï¼‰
- **ä»£ç é‡å¤**: å‡å°‘ 80%ï¼ˆå…¬å…±å‡½æ•°åº“ï¼‰
- **æµ‹è¯•å‘ç°**: æ”¹è¿›æ ‡ç­¾ç³»ç»Ÿï¼Œæ›´å¿«çš„è¿‡æ»¤
- **å¹¶è¡ŒåŒ–**: æ‰€æœ‰è„šæœ¬æ”¯æŒ `--jobs` å‚æ•°

## ä½¿ç”¨ç¤ºä¾‹

### æ—¥å¸¸å¼€å‘å·¥ä½œæµ

```bash
# 1. å¼€å‘æ„å»º
./scripts/build --dev

# 2. è¿è¡Œç›¸å…³æµ‹è¯•
./scripts/test --unit --filter "*myfeature*"

# 3. ä»£ç æ ¼å¼åŒ–
./scripts/lint format

# 4. é™æ€åˆ†æ
./scripts/lint tidy-fix
```

### CI/CD å®Œæ•´æµç¨‹

```bash
# å®‰è£…ä¾èµ–
./scripts/install-deps --dev

# æ„å»ºï¼ˆå¸¦è¦†ç›–ç‡ï¼‰
./scripts/build --coverage

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./scripts/test --coverage

# ä»£ç è´¨é‡æ£€æŸ¥
./scripts/lint all

# Sanitizer æ£€æŸ¥
./scripts/build --sanitizer asan
./scripts/test
```

### å‘å¸ƒå‰æ£€æŸ¥

```bash
# æ¸…ç†æ„å»º
./scripts/build --clean

# å¤šé…ç½®æµ‹è¯•
for compiler in gcc clang; do
  for type in Debug Release; do
    ./scripts/build -c $compiler -t $type
    ./scripts/test -c $compiler -t $type
  done
done

# è¦†ç›–ç‡æŠ¥å‘Š
./scripts/test --coverage
open coverage/html/index.html
```

## æµ‹è¯•è¦†ç›–

æœ¬æ¬¡é‡æ„çš„æµ‹è¯•ï¼š
- âœ… æ‰€æœ‰æ–°è„šæœ¬æ‰‹åŠ¨æµ‹è¯•é€šè¿‡
- âœ… CI/CD ç®¡é“éªŒè¯é€šè¿‡
- âœ… æ–°æµ‹è¯•æ¶æ„æ„å»ºæˆåŠŸ
- âœ… è¿ç§»è·¯å¾„éªŒè¯

## å·²çŸ¥é—®é¢˜

### é™åˆ¶
1. **å¹³å°æ”¯æŒ**: æ–°è„šæœ¬ä¸»è¦é’ˆå¯¹ Linux/macOSï¼ŒWindows æ”¯æŒæœ‰é™
2. **Shell ä¾èµ–**: éœ€è¦ Bash 4.0+
3. **å·¥å…·ä¾èµ–**: æŸäº›åŠŸèƒ½éœ€è¦ç‰¹å®šå·¥å…·ï¼ˆlcov, clang-tidyï¼‰

### è®¡åˆ’æ”¹è¿›
- [ ] Windows PowerShell ç‰ˆæœ¬
- [ ] è‡ªåŠ¨ä¾èµ–æ£€æŸ¥å’Œå®‰è£…
- [ ] æ›´å¤šçš„é”™è¯¯æ¢å¤ç­–ç•¥
- [ ] æ€§èƒ½åˆ†æå’Œä¼˜åŒ–å·¥å…·

## å½±å“è¯„ä¼°

### å¼€å‘è€…å½±å“
- **çŸ­æœŸ**: éœ€è¦å­¦ä¹ æ–°å‘½ä»¤ï¼ˆ1-2å¤©ï¼‰
- **é•¿æœŸ**: æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡ï¼ˆ20-30%ï¼‰

### CI/CD å½±å“
- **å˜æ›´å·¥ä½œé‡**: ä½ï¼ˆç®€å•çš„å‘½ä»¤æ›¿æ¢ï¼‰
- **æ‰§è¡Œæ—¶é—´**: æ— æ˜¾è‘—å˜åŒ–
- **å¯é æ€§**: æå‡ï¼ˆæ›´å¥½çš„é”™è¯¯å¤„ç†ï¼‰

### é¡¹ç›®ç»´æŠ¤
- **ä»£ç å¯ç»´æŠ¤æ€§**: å¤§å¹…æå‡ï¼ˆå‡å°‘ 80% é‡å¤ï¼‰
- **æ–‡æ¡£å®Œæ•´æ€§**: æ˜¾è‘—æ”¹å–„
- **æ–°äººä¸Šæ‰‹**: æ›´å®¹æ˜“ï¼ˆæ¸…æ™°çš„æ–‡æ¡£ï¼‰

## ç›¸å…³èµ„æº

### æ–‡æ¡£
- [è„šæœ¬ç³»ç»Ÿæ–‡æ¡£](../scripts/README.new.md)
- [æµ‹è¯•æ¶æ„æ–‡æ¡£](../tests/README.md)
- [è¿ç§»æŒ‡å—](../MIGRATION.md)

### ä»£ç 
- å…¬å…±å‡½æ•°åº“: `scripts/lib/common.sh`
- ç»Ÿä¸€æ„å»º: `scripts/build`
- ç»Ÿä¸€æµ‹è¯•: `scripts/test`
- ä»£ç è´¨é‡: `scripts/lint`

### å·¥å…·
- CMake: æ„å»ºç³»ç»Ÿé…ç½®
- CTest: æµ‹è¯•è¿è¡Œå™¨
- GoogleTest: æµ‹è¯•æ¡†æ¶
- clang-format/clang-tidy: ä»£ç è´¨é‡

## è‡´è°¢

æ­¤æ¬¡é‡æ„åŸºäºé¡¹ç›®æ—©æœŸè¯„ä¼°å’Œç¤¾åŒºåé¦ˆï¼Œç‰¹åˆ«æ„Ÿè°¢ï¼š
- æ‰€æœ‰æä¾›è„šæœ¬é—®é¢˜åé¦ˆçš„è´¡çŒ®è€…
- Code review å‚ä¸è€…
- æµ‹è¯•å’ŒéªŒè¯å›¢é˜Ÿ

## åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- [ ] æ”¶é›†ç¤¾åŒºåé¦ˆ
- [ ] ä¿®å¤è¿ç§»ä¸­å‘ç°çš„é—®é¢˜
- [ ] å®Œå–„æ–‡æ¡£ä¸­çš„ç¤ºä¾‹

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰
- [ ] ä¸ºæ—§è„šæœ¬æ·»åŠ åºŸå¼ƒè­¦å‘Š
- [ ] æ›´æ–°æ‰€æœ‰æ–‡æ¡£å¼•ç”¨
- [ ] CI/CD å®Œå…¨è¿ç§»

### é•¿æœŸï¼ˆ3-6æœˆï¼‰
- [ ] ç§»é™¤æ—§è„šæœ¬
- [ ] è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½
- [ ] æ‰©å±•æµ‹è¯•è¦†ç›–ç‡

## æ€»ç»“

æ­¤æ¬¡é‡æ„æ˜¯ FastQTools é¡¹ç›®æ¶æ„æ¼”è¿›çš„é‡è¦é‡Œç¨‹ç¢‘ï¼š

âœ… **ä»£ç è´¨é‡**: æ¶ˆé™¤é‡å¤ï¼Œæå‡ä¸€è‡´æ€§  
âœ… **å¼€å‘æ•ˆç‡**: æ›´å¿«çš„æ„å»º-æµ‹è¯•å¾ªç¯  
âœ… **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„æ¶æ„ï¼Œå®Œå–„çš„æ–‡æ¡£  
âœ… **æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œå·¥å…·  

è™½ç„¶éœ€è¦ä¸€å®šçš„è¿ç§»æˆæœ¬ï¼Œä½†é•¿æœŸæ”¶ç›Šæ˜¾è‘—ã€‚æˆ‘ä»¬å»ºè®®æ‰€æœ‰å¼€å‘è€…å°½å¿«è¿ç§»åˆ°æ–°çš„è„šæœ¬ç³»ç»Ÿã€‚

---

**å˜æ›´ç±»å‹**: é‡æ„ (Refactor)  
**å½±å“**: æ„å»ºç³»ç»Ÿã€æµ‹è¯•æ¶æ„ã€å¼€å‘å·¥ä½œæµ  
**ç ´åæ€§**: æ˜¯ï¼ˆä½†æä¾›å…¼å®¹æœŸï¼‰  
**æ–‡æ¡£**: å®Œæ•´  
**æµ‹è¯•**: é€šè¿‡  
**å®¡æŸ¥**: å®Œæˆ
