# 解析器鲁棒性优化文档

## 1. 背景与动机
FastqReader 在追求高性能的同时，牺牲了一定的安全性。如果输入文件格式微损（如丢失换行符、ID行标识符等），当前的解析器可能会产生静默错误（解析出错误的 Record），或者在不可预知的位置崩溃。增加鲁棒性对于生产环境至关重要。

## 2. 优化方案
- **严格校验**:
    - 确保第一行以 '@' 开头。
    - 确保第三行以 '+' 开头。
- **错误报告**:
    - 当断言失败时，抛出 `std::runtime_error`。
    - 错误信息中包含：
        - 文件路径 (文件名)
        - 近似行号 (Line Number) 或 Record Number。
        - 错误的具体内容（Context）。

## 3. 实现细节
- 在 `FastqReader::nextBatch` 主循环中，当找到一个可能的 Record 起始点时：
    - 检查 `*ptr == '@'`。如果不是，这可能不是一个合法的起始，或者文件指针错位。
    - 检查 `line3Start` 处是否为 `+`。
- **Happy Path Optimization**: 使用 `__builtin_expect` 或者 `[[likely]]` (C++20) 来标记正常分支，确保校验代码不影响热路径的分支预测。

## 4. 变更记录
- `src/io/fastq_reader.cpp`: 增加格式检查逻辑。

